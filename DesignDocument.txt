# Skyline Survivors: Urban Defender â€“ Design Document v2.0

## 1. Core Concept
A modern reimagining of *Defender/Stargate* fused with *Strike Force*, *Vampire Survivors*, and *Blaster Master*-style vehicle/foot combat.

**Key Themes:**
*   **Defend and Reclaim:** Districts exist in three states (Friendly, Threatened, Occupied).
*   **Active Deployment:** Humans are not just scoring items; they are the ammunition for your ground game.
*   **Seamless Transition:** Shift between piloting a heavy strike ship and fighting on foot as a Squad Leader.
*   **The "Comrade" System:** Rescued civilians become armed operatives that provide fire-and-forget support.

**The Hook:** High-intensity "sensory jackpot" combat combined with a strategic layer that leverages Loss Aversion and specific "Rescue-to-Deploy" gameplay loops.

---

## 2. High-Level Structure

### 2.1. System View Orbital Map
**Purpose:** Strategic command center showing planetary control status.
**Elements:**
*   **City Districts (Nodes):**
    *   ðŸŸ¢ **Friendly (Secured):** Accumulates "Prosperity Multiplier" (resources).
    *   ðŸŸ¡ **Threatened (Under Attack):** Requires Defense Mission. Timer based.
    *   ðŸ”´ **Occupied (Enemy Controlled):** Requires Assault Mission. Prosperity reset to zero (Loss Aversion).
*   **The "Near-Miss" Timer:** When a Threatened timer hits zero, it flashes "CRITICAL" for 30s. Starting a mission here grants a "Clutch Defense" bonus.
*   **Roaming Battleships:** Mobile boss nodes that block progress/shop items.

**Mechanics:**
*   **Consequence System:** Ignoring Threatened â†’ District falls to Occupied â†’ Requires Assault.
*   **Victory Condition:** Secure all districts â†’ Unlock Mothership assault.

### 2.2. Side-Scrolling Combat View
**Perspective:** Horizontal wraparound map above a cityscape.
*   **Defense Missions:** Defend 1 fixed **Extraction Hub (Fortified Hangar)**. 15 Waves.
*   **Assault Missions:** Push into enemy territory to destroy a Ground Base.
*   **Key Features:** Radar HUD, Parallax Cityscape, Day/Night Cycle.

### 2.3. Meta Progression & Shop
**2.3.1. The "Supply Drop" Gacha Shop**
*   **Concept:** Variable Ratio Reinforcement. Spend credits on "Supply Drops" for single-mission advantages.
*   **Inventory:** Items are "Hot Starts" (e.g., start with Tier 2 Laser) that apply only to the next run.

**2.3.2. The Shop "Dopamine" Sequence**
*   **Visuals:** Satellite charges energy (color indicates rarity) -> Pod slams into hangar (Screen Shake) -> God Rays reveal item.
*   **Audio:** Shepard Tone build-up -> Bass Thud -> Casino Win Chime.

---

## 3. Gameplay Overview & The Rescue Loop

### 3.1. The Rescue & Drop-Off Loop
Instead of humans being passive scoring items, they are the primary resource for ground-game momentum.

1.  **Extraction Hubs:** Each district features 1 fixed aerial **Fortified Hangar** (Drop-off Point). These are the only locations where civilians can be converted into "Comrades."
2.  **The "Strike Force" Carry:** When the Aegis hovers over a human, they are tractor-beamed into cargo.
    *   *Mechanic:* Carrying humans increases ship weight/inertia.
    *   *Risk/Reward:* Holding multiple humans yields a higher deployment bonus but makes the Aegis harder to maneuver during high-intensity waves.
3.  **Tactical Deployment:** Dropping off humans at the Hangar triggers a **Deployment Animation**.
    *   *Result:* A squad of 3â€“5 armed operatives exits the Hangar to join the fray on the ground below.

### 3.2. Core Loop
1.  **System Map:** Choose Defense (Threatened) or Assault (Occupied).
2.  **Combat:** Pilot the Aegis -> Rescue Humans -> Deploy Comrades -> Survive Waves.
3.  **Crisis:** If the Aegis is destroyed -> Enter On-Foot Command -> Rebuild at Hangar.
4.  **Extraction:** Complete Wave 15 or Destroy Base.

---

## 4. Player Mechanics & Operative Systems

### 4.1. The Aegis: Forms & Movement
**4.1.1. Interceptor Mode (Interceptor Form)**
*   **Movement:** 8-directional. Inertia scales based on number of humans in cargo.
*   **Primary Weapon:** Forward blaster.
*   **Secondary:** Smart Bomb / Hyperspace.

**4.1.2. Bulwark Mode (Bulwark Replacement)**
*   **Activation:** Toggle button.
*   **Movement:** Drastically slowed.

### 4.2. Operative AI & Combat Behavior ("The Comrades")
These soldiers provide "fire-and-forget" support, making the battlefield feel alive.

**4.2.1. Formation Tactics**
*   Comrades move in small fire teams.
*   They automatically engage the nearest threat but will prioritize protecting the player if the player is on foot.

**4.2.2. Weapon Scaling**
*   Operatives start with basic rifles.
*   **Tier Overflow:** If the player picks up a Weapon Power-Up while the Aegis is already at **Tier 3 (Max)**, the "excess" power is distributed to ground troops, upgrading their fire rate or damage output permanently for that mission.

**4.2.3. Operative Classes**
| Operative Type | Rarity | Combat Behavior & Abilities |
| :--- | :--- | :--- |
| **Standard Infantry** | Common (65%) | Equipped with a rapid-fire rifle; auto-fires at nearest enemy. Moves in small squads to provide basic screen coverage. |
| **Heavy Gunner** | Uncommon (20%) | High DPS unit with a Gatling-style weapon. Slows down to a "braced" position to shred through Bombers or Pods. |
| **Saboteur** | Elite (5%) | Specifically targets **Enemy Ground Bases** in Assault Missions. Uses EMP grenades to disable Turrets and Shield Generators. |
| **Medic** | Rare (10%) | Prioritizes keeping nearby Comrades and the on-foot pilot alive via sustain pulses and support positioning during rebuild/extraction pressure. |

### 4.3. On-Foot Command (Ship Destruction)
If the Aegis is destroyed, the game does not end. The pilot ejects, and the genre shifts to a run-and-gun survival mode.

**4.3.1. Squad Leader Aura**
*   When on foot, nearby Comrades stop patrolling and follow the player's movement exactly.
*   **Visual:** This creates a "Bullet Hell" wall of return fire (similar to "Options" in *Gradius*), concentrating firepower wherever the pilot moves.

**4.3.2. Extraction Defense (Rebuild Mechanic)**
*   To rebuild the Aegis, the pilot must reach the **Fortified Hangar** (Drop-off point) and stand their ground.
*   **Sacrifice:** While the "Ship Rebuild" timer ticks down, Comrades will physically body-block incoming enemy fire, sacrificing themselves to ensure the pilot gets back in the air.

### 4.4. Power-Up System
**4.4.1. Core Upgrades**
*   **Weapons:** Laser, Spread Shot, Homing Missiles (3 Tiers each).
*   **Defense:** Shields, Speed Boost.
*   **Utility:** Smart Bombs, Score Multipliers.

**4.4.2. Advanced Systems**
*   **Weapon Decay:** Power-ups have duration; encourages aggression.
*   **Mystery Drops:** Random effects/Jackpots.
*   **Assault Rewards:** Destroying base sections reveals rare power-ups.

### 4.5. Implemented Player Weapon System (Code-Accurate)
This section reflects the current in-code behavior of the player weapon stack.

**4.5.1. Fire Trigger, Rate, and Aiming Context**
*   Firing is gated by `playerState.lastFire + playerState.fireRate`; default cadence is 200ms between shots.
*   `rapid` and `overdrive` are timed modifiers that lower fire interval to 80ms and 50ms respectively while active.
*   The same fire pipeline is used for both AEGIS and pilot states, with context aim overrides:
    *   Pilot aim resolves from directional input (`getPilotAimAngle`).
    *   Bulwark mode uses an explicit aim angle (`aegisState.aimAngle`).

**4.5.2. Primary Weapon Routing (Laser vs Multi-Shot)**
*   The active primary path is `playerState.primaryWeapon` and can be switched when both trees are available.
*   If no explicit selection exists, logic defaults to Laser when available, otherwise Multi-Shot.
*   Selection auto-normalizes when tiers decay or are lost on death (prevents invalid primary states).

**4.5.3. Shot Pattern and Tier Behavior**
*   Multi-Shot tiers drive pattern geometry:
    *   Tier 0: single forward shot.
    *   Tier 1: twin parallel barrels.
    *   Tier 2: 3-way spread (`-0.15, 0, +0.15` radians).
    *   Tier 3: 5-way spread (`-0.25 ... +0.25` radians).
*   Laser tiers repurpose the same projectile pipeline but change projectile class:
    *   Tier 1: piercing beam projectile.
    *   Tier 2: wave projectile with sinusoidal lateral motion.
*   A global Piercing pickup also promotes baseline shots to piercing behavior.

**4.5.4. Coverage, Missiles, Overdrive, and Drones**
*   Coverage level 1 adds rear fire (180Â° opposite aim vector).
*   Coverage level 2 adds left/right side vectors (Â±90Â°), giving near-omnidirectional pressure.
*   Missile power-up spawns a homing projectile each trigger cycle; tier is stored per projectile (`homingTier`).
*   Overdrive adds two extra offset flame bolts each shot and concurrently enforces the fastest fire cadence.
*   Active force drones orbit the current avatar and each emit one forward drone projectile per player shot.

**4.5.5. Projectile Lifecycle and Special Logic**
*   All player projectiles store `damage`, `projectileType`, piercing flag, spawn time, and travel tracking.
*   Lifetime controls are dual-layered: hard timeout (~3s) plus range fade-out (`maxRange` based on initial speed).
*   Wave projectiles continuously alter velocity using a sine-based perpendicular offset.
*   Homing projectiles retarget nearby enemies only at missile tier 2+.
*   Tier-3 homing impacts can fork into 3 cluster homing missiles, prioritizing nearest hostile entities across enemy, garrison, boss, battleship, and assault-target groups.

**4.5.6. Damage Application Rules**
*   Base player projectile damage is 1; Double Damage temporarily raises it to 2.
*   Non-piercing shots are consumed on impact; piercing/wave shots continue through targets.
*   The same damage payload is respected by enemy, garrison, boss, battleship, and assault objective hit handlers, while boss/battleship/base shield-phase systems may gate whether damage applies to shield or HP.

**4.5.7. Power-Up Acquisition, Decay, and Overflow**
*   Weapon-tier power-ups are bounded (`laser` max 2, `multiShot` max 3, `missile` max 3, `coverage` max 2).
*   Decay timers are tracked per upgrade path (`laser`, `multiShot`, `coverage`, `missile`) with shorter durations in assault mode.
*   On decay expiration, the relevant tier drops by one and timer refreshes for the new tier until it reaches zero.
*   Overflow behavior is implemented: collecting a maxed tier in eligible paths converts into a comrade upgrade level (up to 12), improving operative durability and associated buff scaling.

### 4.6. Implemented Weapon Pickup System (Code-Accurate Deep Dive)
This section documents the exact pickup flow for weapon-related power-ups from spawn source to runtime state mutation.

**4.6.1. Where Weapon Pickups Come From**
*   **Random combat drops:**
    *   Standard enemies have a 12% drop chance on death.
    *   Garrison defenders have a 9% drop chance on death.
    *   Rescued falling/abducted humans have a 24% chance to drop a pickup.
*   **Guaranteed boss payout:** Boss deaths spawn two pickups.
*   **Support-generated pickup:** Medic support can spawn a short-lived shield pickup using the same world pickup group.
*   All of these routes converge into the same `spawnPowerUp`/`powerUps` collection path (except supply drops, which apply directly to state and do not spawn world entities).

**4.6.2. Pickup Type Pool and Spawn Representation**
*   Runtime world pickups are rolled uniformly from a 16-type pool:
    *   `laser`, `drone`, `shield`, `missile`, `overdrive`, `rear`, `side`, `rapid`, `multiShot`, `piercing`, `speed`, `magnet`, `bomb`, `double`, `invincibility`, `timeSlow`.
*   Spawned pickups are Phaser group entities with:
    *   sprite key `powerup_<type>`
    *   gameplay depth set above normal actors
    *   floating yoyo tween for readability
    *   hard despawn timer (30s default, 8s for medic shield spawns)

**4.6.3. How Collection Is Triggered**
*   Collision overlap is registered for both controllable forms:
    *   AEGIS â†” pickup
    *   Pilot â†” pickup
*   On overlap, `collectPowerUp` is the single effect dispatcher used for all pickup types.
*   On collect, the player always receives score bonus + collection SFX + floating label feedback before type-specific effects are applied.

**4.6.4. Weapon Pickup Effects (Exact State Changes)**
*   `laser`: increments `playerState.powerUps.laser` up to tier 2, refreshes laser decay timer, and can set primary weapon to laser.
*   `multiShot`: increments `playerState.powerUps.multiShot` up to tier 3, refreshes multishot decay timer, and can set primary weapon to multishot.
*   `missile`: increments missile tier up to 3 and refreshes missile decay timer.
*   `rear` / `side`: both map into shared `coverage` tier (max 2) and refresh shared coverage decay timer.
*   `piercing`: sets piercing active and ensures laser tier is at least 1 (with decay timer refresh if laser tier is raised).
*   `drone`: increments drone count up to 3 and instantiates a new orbiting drone entity immediately.
*   Related combat modifiers that affect weapon output but are timed rather than tiered:
    *   `rapid` â†’ 10s fire-rate boost
    *   `overdrive` â†’ 7s overdrive + fastest fire-rate profile
    *   `double` â†’ 8s double-damage window

**4.6.5. Decay and Tier Loss After Pickup**
*   Only four weapon paths are decay-tracked: `laser`, `multiShot`, `coverage`, `missile`.
*   Decay duration is tier-specific and comes from `POWERUP_DECAY_CONFIG`; assault mode applies a 0.75 duration multiplier.
*   When a decay timer hits zero, that path loses exactly one tier, triggers UI warning flash, and re-arms the next lower-tier timer if still above zero.
*   Primary weapon selection is auto-normalized after decay so the active weapon never points to a depleted path.

**4.6.6. Overflow Conversion (When a Pickup Is Already Maxed)**
*   Overflow is checked **before** normal pickup application.
*   Eligible overflow paths: `laser`, `multiShot`, `missile`, `rear`, `side`.
*   If incoming pickup is already at cap, the pickup is converted into a comrade upgrade instead of increasing weapon tier.
*   Overflow upgrade raises `playerState.comradeBuffs.level` (cap 12), boosts operative survivability immediately, and triggers dedicated upgrade VFX/banner messaging.

**4.6.7. Meta Supply Drop Interaction With Weapon Pickups**
*   Supply drops are a separate pre-mission system: purchased loot is stored as pending and applied directly to `playerState.powerUps`/`gameState` on mission start.
*   Because supply drops bypass world pickup entities, they do not invoke `collectPowerUp`, do not show in-world pickup labels, and do not use pickup-overlap collision.
*   Functionally, they seed starting weapon tiers/durations that then continue through the same firing, decay, and normalization logic as in-world pickups.

---

## 5. Enemy Design

### 5.1. Core Enemy Types
*   **Lander:** Descends to capture humans. If successful, ascends.
*   **Mutant:** Created from captured humans. Aggressive seeker.
*   **Bomber:** Drops mines; area denial.
*   **Pod:** Releases swarms of smaller enemies.
*   **Baiter:** Spawns if the player takes too long (anti-camping).
*   **Swarmer:** Fast, weak, overwhelms in groups.

### 5.2. Advanced Behaviors
*   **Kamikaze:** Charges and explodes on contact.
*   **Shield:** Absorbs shots; requires flanking or piercing.
*   **Sniper:** Stationary; fires high-speed shots after a delay.
*   **Healer (Regenerator):** Heals nearby biological enemies (Mutants).

### 5.3. Bosses
*   **Mega Lander:** Giant UFO with tentacles.
*   **Titan Mutant:** Massive humanoid with multiple arms.
*   **Leviathan Baiter:** Serpentine sea-monster silhouette.
*   **Fortress Turret:** Multi-barrel stationary platform.

### 5.4. Base Defenses (Assault Only)
*   **Turrets:** Auto-targeting. Saboteurs can disable these.
*   **Shield Generators:** Protect the core. Must be destroyed first.
*   **Garrison Forces:** Elite troops that only spawn within base perimeters.

---

## 6. Game Systems & UI

### 6.1. Radar / HUD
*   **Mini-Radar:** Shows Player, Comrades (Blue dots), Mutants/Enemies (Red dots), Pickups.
*   **Engagement Tracking:** A "Combo Meter" that does not reset as long as the player moves toward an objective (Flow state).
*   **Visual Urgency:** Radar pulses faster as "Near-Miss" timers approach zero.

### 6.2. Scoring & Rewards
*   **Points:** Kills, Rescues, Base Destruction.
*   **Comrade Bonus:** Significant points for every Operative alive at mission end.
*   **Reconversion:** Rescuing a human from a Lander/Mutant grants bonus points.

---

## 7. Progression & Modes

### 7.1. Planetary Liberation Campaign
*   **Structure:** Start with ~40% friendly districts.
*   **Dynamic:** Failed defenses lead to Occupied districts (Assault missions).
*   **Endgame:** Secure 100% of districts to unlock the Mothership.

### 7.2. Mission Types
*   **Defense:** 15 Waves. Focus on keeping the Fortified Hangar safe and deploying troops.
*   **Assault:** Two-phase strike. First destroy the exterior base core, then board and destroy the interior reactor core.
*   **Mothership:** A two-part finale: exterior core siege followed by an interior boarding run-and-gun objective chain.

#### 7.2.1. Assault Base Interior Breach (Run-and-Gun Phase)
*   **Transition Trigger:** Destroying the assault base exterior core now starts a breach sequence instead of immediate mission completion.
*   **Pilot-Only Lock:** The AEGIS is disabled/locked and the player must continue on foot as the pilot during interior combat.
*   **Battleship-Specific Interiors:** Assault interiors swap to one of five procedural interior themes based on the active base variant: **Raider, Carrier, Nova, Siege,** or **Dreadnought**.
*   **Objective Chain:** Destroy all interior **Power Conduits** and **Security Nodes** to expose the interior **Core Chamber**, then destroy the reactor core.
*   **Pressure Model:** Interior defenders and turret fire continue to reinforce throughout the breach phase.
*   **Win Condition:** Assault mission success is now granted only after both phases are complete (exterior destruction + interior reactor kill).

#### 7.2.2. Mothership Interior Boarding (Run-and-Gun Phase)
*   **Transition:** Destroying the exterior core triggers a breach/boarding sequence and forces pilot-only gameplay (AEGIS locked).
*   **Traversal:** Procedurally generated interior platforms + ladders create a side-on run-and-gun route with verticality (Contra/Metal Slug-inspired cadence).
*   **Objectives:** Destroy all **Power Conduits** and **Security Nodes** to open the **Core Chamber**.
*   **Pressure:** Interior defenders and turret fire reinforce continuously until the reactor core is destroyed.
*   **Win Condition:** Destroy the interior reactor core chamber to complete campaign victory.

### 7.3. Challenges
*   **"Last Stand":** Infinite waves, global leaderboard.
*   **"Assault Only":** All districts start Occupied.

---

## 8. Environment & Audio

### 8.1. Environment
*   **Layers:** Parallax cityscape (Industrial, Residential, Military).
*   **Destruction:** Buildings take damage from enemy fire and crashed ships.
*   **Weather:** Rain/Fog affects visibility.

### 8.2. Audio Design
*   **Music:** Adaptive layers (Atmospheric -> High Energy -> Boss).
*   **SFX:** Distinct weapon sounds. "Casino-style" sounds for Shop and Deployment.
*   **Feedback:**
    *   **Rescue:** Satisfying "Lock-and-Load" sound when beaming up humans.
    *   **Deployment:** Sound of boots hitting the ground and radio chatter ("Squad deployed!") when dropping off at the Hangar.

---

## 9. Key Design Changes Summary 
*   **Resource vs. Score:** Humans are now ammunition for the ground war via the "Strike Force" Carry and Deployment system.
*   **Inertia Mechanic:** Carrying humans adds weight, creating a risk/reward balance.
*   **Operative Depth:** Added 3 distinct classes (Infantry, Gunner, Saboteur) and AI behaviors (Defensive Perimeter).
*   **Weapon Synergy:** Tier 3 ship overflow upgrades ground troops.
*   **Second Chance Mechanic:** On-Foot Command turns the pilot into a Squad Leader, using "Bullet Hell" squad tactics and "Sacrifice" mechanics to rebuild the Aegis.
---

## 10. Phase-Gated Boss Flow (v2.1 Update)

### 10.1 Unified Shield/HP Phase Architecture
All major encounters now follow a shared cadence:
1. **Shield Stage Gate** (core HP protected)
2. **Burst Damage Window** (short core vulnerability)
3. **Intermission / Shield Re-prime** (if stage chain remains)

This applies to:
- Core Bosses
- Mini-boss battleships
- Assault mission base cores
- Mothership core encounter

### 10.2 Behavior Driven by Encounter Phase (Not HP Ratio)
Boss and battleship attack timing now references the phase controller state rather than raw HP %, enabling deterministic progression beats for tuning and readability.

### 10.3 HUD/Status Alignment
Encounter HUD labels now report:
- Current phase index (e.g., Phase 2/3)
- Shield gate state (shield HP or exposed core)
- Active damage-window countdown when relevant

### 10.4 Design Intent
The new system reinforces:
- Better fight rhythm and recovery windows
- Stronger mission readability and anticipation
- Consistent final-boss language across all mission archetypes
