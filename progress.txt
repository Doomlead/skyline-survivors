# Skyline Survivors: Urban Defender

## 1. Core Concept

**Implementation Status: 78% Complete**  

### Key Themes Progress:

✅ **Fully Implemented:**
- Urban defense gameplay with district-based missions
- Ship/foot combat transitions via pilot ejection system
- Human rescue mechanics with landers and mutants
- Escalating difficulty through wave systems and boss encounters
- **Defend and Reclaim**: Districts exist in three states (Friendly/Threatened/Occupied)
- **Squad Leader Fantasy (Core Loop):** On-foot aura, formation follow, and sacrifice/body-block behaviors
- **Active Deployment:** Humans convert into operatives when dropped at the hangar
- **Mothership Finale Structure:** Exterior boss breach transitions into an interior pilot-only boarding phase

⚠️ **Partially Implemented:**
- **Seamless transition (Ship/Foot):** Ejection + hangar rebuild + squad leader aura exist, but Bulwark/ground synergies and stronger UI messaging are missing.
- **Resource vs. Score (The Rescue Loop):** Cargo collection + deployment are in place; operative overflow scaling now routes max-tier pickups into comrade buffs with HUD/FX, but deeper squad synergy feedback loops still need polish.
- **Strategic Territory Control:** District states, timers, and prosperity investment are in; still needs tuning/balance.
- **Operative Depth:** 4 distinct classes exist with combat behaviors (Infantry, Gunner, Medic, Saboteur); Tier Overflow scaling now boosts ground troops, but stronger fire-team coordination outside of the on-foot formation is still minimal.

---

## 2. High-Level Structure

### 2.1. System View Orbital Map

**Implementation Status: 88% Complete**

✅ **Fully Implemented:**
- 3D rotating globe with selectable districts
- **City districts** displayed as nodes with three states (Friendly, Threatened, Occupied)
- **Battleships** roam between nodes
- **Special node:** Mothership (Endgame)
- Consequence system: Threatened → Occupied
- **Victory Condition:** Complete Mothership assault
- Threat timer-based urgency and pulsing visuals for threatened districts
- Critical urgency logic drives spawn/reward multipliers
- Prosperity investment loop with loss-aversion reset on occupied districts

⚠️ **Partially Implemented:**
- **The "Near-Miss" Timer:** Explicit 30s "CRITICAL" window and clutch-defense bonus are now implemented, with added map/HUD pulse FX (additional polish still possible).
- **District Investment Levels (Dark Pattern):** Prosperity multiplier exists with stronger map/HUD feedback; still needs balance tuning and cinematic polish.

### 2.2. Side-Scrolling Combat View

**Implementation Status: 78% Complete**

#### Defense Missions (Threatened Districts)
**Implementation Status: 82% Complete**
✅ **Fully Implemented:**
- Defend districts (15 waves) / Wave tier progression
- Mini-boss and boss encounters / Battleship encounter
- Extraction hub hangar with landing zone rebuild pad
- **Deployment Animation:** Dropping off cargo spawns operative squads

#### Assault Missions (Occupied Districts)
**Implementation Status: 75% Complete**
✅ **Fully Implemented:**
- Base core objective with HP / Shield generators / Turrets
- Garrison defender squads
- **Saboteur Synergy:** EMP-style disables against turrets/shields

#### Mothership Finale (Endgame)
**Implementation Status: 92% Complete**
✅ **Fully Implemented:**
- Exterior mothership core encounter with phase-gated shields/damage windows
- Automatic transition into interior boarding phase after hull breach
- Pilot-only run-and-gun gameplay with procedural platforms and ladders
- Interior objective chain (power conduits + security nodes -> core chamber)

⚠️ **Partially Implemented:**
- Additional cinematic polish for the breach-to-interior transition

❌ **Not Implemented:**
- **Bulwark Form Synergy:** Increased effectiveness against structures
- **Assault Rewards:** Loot drops and jackpots on base destruction

---

## 3. Gameplay Overview & The Rescue Loop

### 3.1 The Rescue & Drop-Off Loop (New v2.0 Section)

**Implementation Status: 88% Complete**

✅ **Fully Implemented:**
- Basic Human Rescue (picking up a human)
- **"Strike Force" Carry:** Multiple humans stored in cargo with HUD indicator
- **Inertia Scaling:** Ship physics change based on cargo count
- **Tactical Deployment:** Dropping humans at the Hangar spawns AI Comrades

⚠️ **Partially Implemented:**
- **Operative Scaling Feedback:** Squad size and power scaling lacks strong UI/FX feedback loops

### 3.2 Core Loop

**Implementation Status: 85% Complete**
✅ **Fully Implemented:**
- System Map -> Combat -> Upgrade cycle
- Ship Destruction -> Ejection
- Crisis Management: on-foot rebuild by holding the landing zone under the hangar

---

## 4. Player Mechanics & Operative Systems

### 4.1. Ship Forms & Movement

**Implementation Status: 90% Complete**

✅ **Fully Implemented:**
- **Normal Interceptor Form:** 8-directional movement, Primary Weapon, Smart Bomb, Hyperspace
- **Bulwark Form:** Toggle, Slowed movement, 360° aim

⚠️ **Partially Implemented:**
- **Bulwark Assault Synergy:** No structural damage or siege bonuses yet

### 4.2. Operative AI & Combat Behavior ("The Comrades")

**Implementation Status: 80% Complete**

✅ **Fully Implemented:**
- Operative spawning from hangar deployment
- **Operative Classes:** Infantry, Gunner, Medic, Saboteur (Medic is live and integrated into follow/aura behaviors)
- **Formation + Aura:** On-foot squad formation, fire-rate aura, and formation offsets
- **Saboteur Assault Logic:** Assault targets prioritized with EMP disable

⚠️ **Partially Implemented:**
- **Fire-Team Coordination:** Patrol behaviors exist, but stronger group coordination and defensive perimeter logic are still minimal when the pilot is airborne.
✅ **Newly Implemented:**
- **Weapon Synergy:** Tier 3 ship overflow now upgrades ground troops with damage/fire-rate/HP buffs and HUD/FX feedback.

### 4.3. On-Foot Command (Ship Destruction)

**Implementation Status: 82% Complete**

✅ **Fully Implemented:**
- Ejection Sequence (Pilot sprite, basic pistol)
- **Extraction Defense:** Hold the landing zone under the hangar for 30s to rebuild the Aegis (with UI prompt)
- **Squad Leader Aura:** Comrades follow pilot movement in formation, boost fire rate, and re-anchor to the pilot
- **Sacrifice Mechanic:** Operatives body-block incoming projectiles during rebuild

⚠️ **Partially Implemented:**
- **Rebuild Feedback:** Needs clearer HUD emphasis for when sacrifice behavior is active

### 4.4. Power-Up System

**Implementation Status: 70% Complete**

✅ **Fully Implemented:**
- Core Weapons (Laser, Spread, Missiles) - 3 Tiers
- Defensive (Shields, Speed)
- Utility (Smart Bombs, Multipliers)
- Weapon Decay & Switching

❌ **Not Implemented:**
- **Assault Rewards:** Base destruction dropping specific loot
- **Mystery Drops:** Random effects/Jackpots

---

## 5. Enemy Design

**Implementation Status: 100% Complete**
✅ **Fully Implemented:**
- Landers, Mutants, Bombers, Pods, Baiters, Swarmers
- Advanced variants (Kamikaze, Turret, Shield, Seeker, etc.)
- Bosses (Mega Lander, Titan Mutant, etc.)
- Mothership core boss flow

---

## 6. Game Systems

### 6.1. Radar / HUD

**Implementation Status: 82% Complete**

✅ **Fully Implemented:**
- Radar (Player, Enemies, Objectives)
- Mission Objectives (Wave Count / Base HP)
- Threat/urgency display and pulsing map indicators
- Mothership HUD phase and core health

❌ **Not Implemented:**
- **Dark Patterns:** Additional loss-aversion presentation polish (cinematics, audio sting, global UI beat)

### 6.2. Meta Progression (Shop)

**Implementation Status: 88% Complete**

✅ **Fully Implemented:**
- Supply Drop Gacha (Credits, Unboxing, Loot History)
- Pending supply drop inventory display
- **Inventory Hot-Starts:** Supply drop items apply at mission start with HUD callout

---

## 7. Environment Design

**Implementation Status: 60% Complete**

✅ **Fully Implemented:**
- Multi-layer parallax (Sky, City, Street)
- Extraction hub hangar with ground landing zone
- Multiple biome background generators (industrial/cyberpunk/wasteland/mothership)

❌ **Not Implemented:**
- Dynamic Weather/Time of Day

---

## MVP Completion

- **Status:** ~81% complete (core campaign, rescue/deploy loop, and phase-gated encounters are production-ready; major remaining work is pilot progression compliance and assault interior parity).
- **Primary Blockers:** Pilot progression compliance, assault interior design-parity pass, assault reward/jackpot loop, and Bulwark siege payoff in assault spaces.

## Gap Analysis & Next Steps (Codebase Audit Refresh)

### Overall Completion Statistics
- **Design Document Alignment:** ~79% (strong core loop coverage, but pilot progression depth and assault interior spec parity remain below v2.0 targets).
- **Major Milestones Achieved:** Strategic district-state campaign loop, near-miss critical timer behavior, rescue cargo inertia + hangar deployment, class-based operative squads (including saboteur/medic behaviors), pilot ejection + rebuild survival loop, supply-drop economy/hot-start flow, and two-phase assault + mothership encounter structure.
- **Immediate Next Steps (Recommended Order):** (1) Pilot system compliance pass (persistent pilot unlocks, ammo economy, and clearer pilot-weapon UI loop), (2) Assault ship interior compliance pass (enemy set, objective beats, and readability matching the design document), (3) Assault rewards + jackpot identity, (4) Bulwark siege payoff in assault spaces, (5) challenge mode surfacing with score persistence.
- **Estimated Remaining Work:** ~10-15 dev days to reach MVP-level design compliance; ~4-6 additional weeks for full v2.0 parity + polish.
- **Post-MVP Polish (Optional):** Adaptive music intensity layers, cinematic district transition stingers, richer deployment VO/SFX, challenge mutators, biome hazard variants, and expanded autonomous fire-team tactics.
- **MVP Completion:** ~81%
- **Critical Missing Features for Design Document Compliance:** Pilot progression package (persistent unlock catalog + ammo loop + stronger on-foot identity), assault interior compliance (exclusive interior enemies/encounter beats/readability), assault reward/jackpot loop, Bulwark structural synergy, and world reactivity systems.

### Design Document Alignment
**Aligned / Implemented**
- Strategic district states with consequence pressure, critical timer logic, and prosperity loss-aversion behavior.
- Rescue-to-deploy loop (human capture, cargo inertia, hangar conversion into combat operatives).
- Interceptor/Bulwark switching and on-foot rebuild command flow.
- Operative class behaviors including saboteur utility plus overflow-based troop buffs.
- Supply Drop gacha sequence with pending inventory and mission-start hot-start application.
- Unified shield-gate cadence across bosses, battleships, assault core, and mothership core.
- Mothership mission chain with exterior encounter and pilot-only interior objective stage.

**Partially Aligned**
- Pilot combat exists, but the full design-doc pilot progression package (persistent unlock offers, stronger weapon identity surfacing, and mission-loop ammo reinforcement) needs a dedicated completion pass.
- Assault interiors are functional (phase transition + conduit/node/core flow), but they still need stronger compliance with the design document’s interior-specific enemy/encounter expectations and presentation clarity.
- Bulwark currently has handling identity but still lacks explicit structural DPS/siege messaging in assault.
- Environment framework is broad (multiple biome generators), but weather/destruction readability and reactive world-state visuals are still thin.

**Not Yet Aligned (Major Remaining Gaps)**
- Assault loot rewards + mystery/jackpot outcomes tied to base destruction.
- Fully surfaced challenge modes ("Last Stand" and "Assault Only") with dedicated score loop.
- Weather/visibility systems and stronger destruction-state signaling.

### Major Milestones Achieved
- District campaign + mission routing pipeline (friendly/threatened/occupied).
- Defense and assault mission objective frameworks with staged progression.
- Assault-to-interior phase transition framework with pilot lock and interior objective sets.
- Hangar-centered rebuild and ejection-based second-chance gameplay loop.
- Operative deployment, class variance, and squad sacrifice/body-block behaviors.
- Supply-drop economy, unboxing UX, loot history, and hot-start integration.
- Shared phase-gated encounter architecture rolled out across major mission archetypes.

### Critical Missing Features for Design Document Compliance
1. **Pilot Progression Compliance:** Persistent pilot unlock catalog + clearer pilot HUD identity + mission-loop ammo reinforcement behavior aligned to the design document.
2. **Assault Interior Compliance:** Interior-specific encounter package (enemy mix/behaviors/readability/objective drama) that better matches design intent for assault boarding phases.
3. **Assault Rewards & Mystery Drops:** Guaranteed base-clear reward tables and jackpot outcomes with clear reward callouts.
4. **Bulwark Assault Synergy:** Structural damage multipliers/behaviors and explicit HUD/FX confirmation during assault.
5. **World Reactivity Layer:** Weather variation and stronger district destruction-state readability.

### Immediate Next Steps (Recommended Order)
1. **Pilot system completion sprint (3-4 days)**  
   - Implement persistent pilot unlock offers defined by the design doc and wire them cleanly into shop/progression.  
   - Add/finish pilot ammo reinforcement loop and improve pilot weapon HUD switching/readability.  
   - Validate pilot combat feel in both emergency rebuild and interior contexts.

2. **Assault interior compliance sprint (3-4 days)**  
   - Expand interior encounter identity (enemy composition/behaviors/objective pacing) toward design-doc parity.  
   - Improve interior readability (threat telegraphing, objective callouts, and set-piece clarity).  
   - Tune transition flow so assault exteriors/interiors feel like one cohesive mission arc.

3. **Implement assault reward identity (2-3 days)**  
   - Base-clear loot table and jackpot roll path.  
   - Reward banner and post-mission summary entries for assault payouts.

4. **Implement Bulwark siege pass (1-2 days)**  
   - Structural damage bonus against assault objectives.  
   - Live HUD/FX indicator when siege bonus is active.

5. **Ship challenge modes as selectable experiences (2-3 days)**  
   - Menu entries for Last Stand and Assault Only.  
   - Score persistence/reporting for repeat runs.

### Estimated Remaining Work

### MVP Completion
- **Current Progress:** ~81%
- **Remaining Critical Work:**
  - Pilot progression compliance sprint: 3-4 days
  - Assault interior compliance sprint: 3-4 days
  - Assault rewards + jackpot loop: 2-3 days
  - Bulwark siege synergy + HUD feedback: 1-2 days
- **Total to MVP target:** ~10-15 days (including QA/balance buffer)

### Full Design Document
- **High Priority Remaining:** ~21%
  - Pilot progression package and on-foot identity clarity
  - Assault interior compliance and encounter differentiation
  - Assault reward economy and Bulwark assault identity
- **Medium Priority Remaining:** ~42%
  - Weather/destruction reactivity systems
  - Adaptive audio and cinematic urgency polish
  - Deeper autonomous fire-team coordination
- **Low Priority Remaining:** ~70%
  - Leaderboard/mutator expansion
  - District archetype and long-tail replay content growth

### Post-MVP Polish (Optional)
- Adaptive music layers tied to urgency and encounter phase changes.
- Cinematic transition stingers for district fail/recover/liberate events.
- Expanded deployment feedback (radio chatter sets, class-specific VO/SFX).
- Challenge mutators and richer leaderboard segmentation.
- Biome-specific hazard bundles for replay variance.

### What We Should Work On Next (IMO)
**IMO, the pilot layer needs the most work right now, with assault ship interiors as the second highest priority for design-document compliance.**  
The game already has strong macro structure (district flow, rescue loop, boss phasing), but the pilot fantasy is still under-realized compared to the design doc’s promises of persistent pilot weapon identity and deeper on-foot progression. In parallel, assault interiors are mechanically present but need stronger authored identity (encounter flavor, enemy behavior differentiation, and objective drama) to feel fully compliant rather than functional.

**Recommended immediate focus order:**
1. Pilot progression + pilot combat UX completion.
2. Assault ship interior compliance pass.
3. Assault rewards/jackpot emotional payoff.
4. Bulwark siege role clarity.
5. Challenge mode productization.

## Pilot Weapon Addendum Compliance Update (4.4+)
- Added pilot weapon module files:
  - `js/entities/player/pilotWeapons/pilotWeaponConfig.js`
  - `js/entities/player/pilotWeapons/pilotWeaponState.js`
  - `js/entities/player/pilotWeapons/pilotWeaponController.js`
  - `js/entities/player/pilotWeapons/pilotWeaponEffects.js`
  - `js/entities/items/pilotWeaponPickups.js`
- Updated `js/config/config.js` with persistent pilot weapon state model (owned weapons, ammo pools, tiers, active weapon, drone/status fields) and reset wiring.
- Updated `js/entities/player/playerControls.js` TAB behavior to cycle pilot weapons in pilot/interior contexts while preserving ship primary switching elsewhere.
- Updated `js/entities/items/powerups.js` to branch pilot-weapon pickup handling from ship power-up handling.
- Updated `partials/game-layout.html` with pilot weapon HUD slot block (icon/name/ammo/tier/drone/status).
- Updated `js/ui/uiState.js` + `js/ui/uiHud.js` to bind and refresh pilot weapon HUD in on-foot/interior mode.
- Updated `js/config/metaProgression.js` with persistent pilot unlock/tier model and accessors for pilot shop unlocks.
- Updated `js/entities/assault/assaultBaseCore.js` and `js/entities/bosses/mothershipCore.js` to initialize pilot loadout/HUD mode on interior start.
- Updated `js/entities/friendlies/hangarBehavior.js` to apply pilot ammo reinforcement from rescue drop-offs.
